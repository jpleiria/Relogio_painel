<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Painel CMOS Leiria</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* --- RESET & BASICS --- */
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Outfit', sans-serif;
            color: #ffffff;
            height: 100vh; height: 100dvh; width: 100vw;
            overflow: hidden;
            background-color: #1a202c;
            cursor: default;
            user-select: none;
            transition: all 0.5s ease; /* Importante para o Pixel Shift suave */
        }

        /* --- BACKGROUND --- */
        .background-wrapper {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1; overflow: hidden;
            /* Scale aumentado para permitir o Pixel Shift sem mostrar bordas pretas */
            transform: scale(1.02); 
        }

        .bg-image {
            width: 100%; height: 100%;
            object-fit: cover; object-position: center 60%;
            filter: brightness(0.45) saturate(0.6) contrast(1.1);
            animation: subtlePan 60s infinite alternate ease-in-out;
            transform: scale(1.1);
        }

        .vignette {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at center, rgba(0,0,0,0.1) 0%, rgba(0,0,0,0.9) 100%);
            pointer-events: none;
        }

        /* --- HUD ALERTA (Borda Vermelha) --- */
        body.shift-alert-active {
            box-shadow: inset 0 0 0 15px #dc2626, inset 0 0 50px rgba(220, 38, 38, 0.5);
            animation: borderFlash 1s infinite alternate;
        }

        /* --- FULLSCREEN BTN --- */
        .fullscreen-btn {
            position: absolute; top: 20px; right: 20px;
            color: rgba(255,255,255,0.3); cursor: pointer;
            z-index: 50; transition: opacity 0.3s;
            font-size: 1.2rem;
        }
        .fullscreen-btn:hover { color: rgba(255,255,255,0.8); }

        /* --- WATCHDOG (Online Status) --- */
        .watchdog-indicator {
            position: absolute; bottom: 15px; right: 15px;
            width: 8px; height: 8px; border-radius: 50%;
            background-color: #22c55e; /* Verde */
            box-shadow: 0 0 8px #22c55e;
            z-index: 50; transition: all 0.3s ease;
        }
        .watchdog-indicator.offline {
            background-color: #ef4444; /* Vermelho */
            box-shadow: 0 0 15px #ef4444;
            animation: blinkFast 1s infinite;
        }

        /* --- LAYOUT --- */
        main {
            height: 100%; width: 100%;
            display: flex; flex-direction: column;
            align-items: center;
            padding: 4vh 3vw;
        }

        /* --- RELÓGIO --- */
        .clock-section {
            text-align: center; width: 100%;
            text-shadow: 0 4px 15px rgba(0,0,0,0.8);
            transition: transform 0.3s ease;
            z-index: 10;
        }
        
        body.shift-alert-active .clock-section { transform: translateY(-10px); }

        .time-wrapper {
            font-size: 14vh; font-weight: 800; line-height: 0.9;
            letter-spacing: -0.03em; display: flex; justify-content: center; align-items: baseline;
            cursor: pointer;
        }
        
        .colon { animation: pulse 2s infinite ease-in-out; margin: 0 0.5rem; position: relative; top: -1vh; }
        .seconds { font-size: 4vh; font-weight: 400; opacity: 0.8; margin-left: 1vh; }
        .date-display {
            font-size: 2.5vh; font-weight: 400; text-transform: uppercase; letter-spacing: 0.3em;
            margin-top: 1vh; opacity: 0.9;
        }

        /* --- ÁREA CENTRAL DE ALERTA --- */
        .shift-anim-container {
            flex-grow: 1; width: 100%;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            gap: 30px; opacity: 0;
            transition: opacity 0.5s ease;
            pointer-events: none;
        }

        body.shift-alert-active .shift-anim-container { opacity: 1; }

        .shift-title {
            font-size: 2.5rem; font-weight: 800; text-transform: uppercase; letter-spacing: 4px;
            color: #ef4444; text-shadow: 0 0 20px rgba(220, 38, 38, 0.8);
            background: rgba(0,0,0,0.4); padding: 10px 40px; border-radius: 50px;
            border: 1px solid rgba(239, 68, 68, 0.3);
            transform: scale(0.9); transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        body.shift-alert-active .shift-title { transform: scale(1); animation: textPulse 1.5s infinite alternate; }

        .cards-row { display: flex; align-items: center; justify-content: center; gap: 50px; perspective: 1000px; }

        .team-card {
            background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2); padding: 25px 40px;
            border-radius: 15px; display: flex; flex-direction: column; align-items: center; gap: 10px;
            min-width: 220px; transform: scale(0.9); transition: transform 0.5s ease, opacity 0.5s ease;
        }

        .team-label { font-size: 0.9rem; text-transform: uppercase; letter-spacing: 2px; opacity: 0.9; font-weight: 600; }
        .team-icon { font-size: 3rem; }

        .outgoing { opacity: 0; transform: translateX(30px); }
        .incoming { opacity: 0; transform: translateX(-30px); }
        .sync-icon { font-size: 2.5rem; opacity: 0; color: #fbbf24; }

        body.shift-alert-active .outgoing { opacity: 1; animation: driftLeft 3s ease-in-out infinite alternate; }
        body.shift-alert-active .incoming {
            opacity: 1; background: rgba(255, 255, 255, 0.15); border-color: rgba(255, 255, 255, 0.5);
            box-shadow: 0 0 30px rgba(255, 255, 255, 0.1); animation: pulseCard 2s ease-in-out infinite alternate;
        }
        body.shift-alert-active .sync-icon { opacity: 0.8; animation: spinSlow 3s infinite linear; }

        /* --- METEOROLOGIA (Com novos dados) --- */
        .weather-section { margin-bottom: 1vh; display: flex; justify-content: center; width: 100%; }
        .glass-card {
            background: rgba(15, 15, 25, 0.65); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.15); border-radius: 20px;
            padding: 20px 30px; display: flex; align-items: center; gap: 40px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.6);
            width: 100%; max-width: 1100px;
        }
        .weather-current-col {
            display: flex; flex-direction: row; align-items: center; gap: 20px; padding-right: 30px;
            border-right: 1px solid rgba(255,255,255,0.15); min-width: 250px; justify-content: center;
        }
        .main-icon-wrapper i { font-size: 3.5rem; filter: drop-shadow(0 0 15px rgba(255,255,255,0.3)); animation: floatIcon 4s ease-in-out infinite; }
        
        .temp-block { text-align: left; display: flex; flex-direction: column; justify-content: center; }
        .city-name { font-size: 0.75rem; letter-spacing: 1px; text-transform: uppercase; opacity: 0.6; margin-bottom: 2px;}
        .temp-line { display: flex; align-items: baseline; gap: 10px; }
        .temp-big { font-size: 3rem; font-weight: 700; line-height: 1; }
        .condition { font-size: 0.9rem; font-weight: 300; opacity: 0.9; margin-bottom: 8px;}
        
        /* Novos Dados Operacionais */
        .operational-data {
            display: grid; grid-template-columns: auto auto; gap: 8px 15px;
            font-size: 0.8rem; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 8px;
        }
        .op-item { display: flex; align-items: center; gap: 6px; opacity: 0.8; }
        .op-item i { width: 16px; text-align: center; color: #93c5fd; }
        .op-val { font-weight: 600; color: #fff; }

        /* Previsões */
        .weather-forecast-col { flex-grow: 1; display: flex; flex-direction: column; gap: 15px; overflow: hidden; text-align: center; }
        .forecast-section-title { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 1.5px; opacity: 0.5; margin-bottom: 8px; font-weight: 600; width: 100%; }
        .scroll-container {
            display: flex; justify-content: space-between; gap: 10px; overflow-x: auto;
            scrollbar-width: none; mask-image: linear-gradient(to right, transparent 0%, black 5%, black 95%, transparent 100%);
            -webkit-mask-image: linear-gradient(to right, transparent 0%, black 5%, black 95%, transparent 100%);
        }
        .scroll-container::-webkit-scrollbar { display: none; }
        .forecast-unit { display: flex; flex-direction: column; align-items: center; flex: 1; min-width: 60px; }
        .f-time { font-size: 0.8rem; opacity: 0.7; margin-bottom: 5px; }
        .f-icon { font-size: 1.2rem; margin-bottom: 5px; opacity: 0.9; }
        .f-temp { font-weight: 600; font-size: 0.9rem; }
        .f-temp.min-temp { font-size: 0.75rem; opacity: 0.6; font-weight: 400; }

        /* --- KEYFRAMES --- */
        @keyframes subtlePan { 0% { transform: scale(1.1) translateY(0); } 100% { transform: scale(1.15) translateY(-2%); } }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        @keyframes floatIcon { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-6px); } }
        @keyframes borderFlash {
            from { box-shadow: inset 0 0 0 10px #b91c1c, inset 0 0 20px rgba(185, 28, 28, 0.5); }
            to { box-shadow: inset 0 0 0 25px #ef4444, inset 0 0 80px rgba(239, 68, 68, 0.8); }
        }
        @keyframes spinSlow { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes blinkFast { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
        
        @keyframes driftLeft {
            0% { transform: translateX(0) scale(0.9); opacity: 0.8; }
            100% { transform: translateX(-15px) scale(0.85); opacity: 0.5; }
        }
        @keyframes pulseCard {
            0% { transform: translateX(0) scale(1); }
            100% { transform: translateX(0) scale(1.05); }
        }
        @keyframes textPulse {
            0% { text-shadow: 0 0 20px rgba(220, 38, 38, 0.5); transform: scale(1); }
            100% { text-shadow: 0 0 40px rgba(220, 38, 38, 1); transform: scale(1.05); }
        }

        @media (max-width: 900px) {
            .glass-card { flex-direction: column; padding: 20px; gap: 20px; }
            .weather-current-col { border-right: none; border-bottom: 1px solid rgba(255,255,255,0.15); padding-right: 0; padding-bottom: 20px; width: 100%; flex-direction: column; text-align: center; }
            .temp-block { align-items: center; }
            .operational-data { justify-content: center; }
            .scroll-container { justify-content: flex-start; gap: 20px; }
            .team-card { min-width: 140px; padding: 15px; } 
            .team-label { font-size: 0.7rem; }
            .shift-title { font-size: 1.5rem; padding: 10px 20px; }
            .cards-row { gap: 20px; }
        }
    </style>
</head>
<body id="body-el">

    <div class="background-wrapper">
        <img src="castle.jpg" alt="Castelo de Leiria" class="bg-image">
        <div class="vignette"></div>
    </div>

    <div class="fullscreen-btn" onclick="toggleFullScreen()" title="Ecrã Inteiro">
        <i class="fa-solid fa-expand" id="fs-icon"></i>
    </div>

    <div class="watchdog-indicator" id="watchdog" title="Estado do Sistema"></div>

    <main>
        <div class="clock-section">
            <div class="time-wrapper" ondblclick="triggerShiftAlert()" title="Duplo clique para testar (1 min)">
                <span id="h">--</span><span class="colon">:</span><span id="m">--</span><span class="seconds" id="s">--</span>
            </div>
            <div id="date-full" class="date-display">A carregar...</div>
        </div>

        <div class="shift-anim-container">
            <div class="shift-title">
                <i class="fa-solid fa-triangle-exclamation" style="margin-right:10px"></i>
                Mudança de Turno
                <i class="fa-solid fa-triangle-exclamation" style="margin-left:10px"></i>
            </div>

            <div class="cards-row">
                <div class="team-card outgoing">
                    <i class="fa-solid fa-users-slash team-icon"></i>
                    <div class="team-label">Piquete de Saída</div>
                    <i class="fa-solid fa-arrow-left-long" style="margin-top:5px; opacity: 0.7;"></i>
                </div>
                
                <i class="fa-solid fa-arrows-rotate sync-icon"></i>
                
                <div class="team-card incoming">
                    <i class="fa-solid fa-users team-icon"></i>
                    <div class="team-label">Piquete de Entrada</div>
                    <i class="fa-solid fa-check" style="margin-top:5px"></i>
                </div>
            </div>
        </div>

        <div class="weather-section">
            <div class="glass-card">
                <div class="weather-current-col">
                    <div class="main-icon-wrapper" id="main-icon">
                        <i class="fa-solid fa-spinner fa-spin" style="font-size: 2rem; opacity: 0.5;"></i>
                    </div>
                    <div class="temp-block">
                        <div class="city-name"><i class="fa-solid fa-location-dot"></i> Leiria, PT</div>
                        <div class="temp-line">
                            <div class="temp-big"><span id="temp-val">--</span>°</div>
                        </div>
                        <div class="condition" id="cond-text">A iniciar...</div>
                        
                        <div class="operational-data">
                            <div class="op-item" title="Vento">
                                <i class="fa-solid fa-wind"></i> 
                                <span class="op-val" id="wind-txt">-- km/h</span>
                            </div>
                            <div class="op-item" title="Direção Vento">
                                <i class="fa-regular fa-compass"></i>
                                <span class="op-val" id="wind-dir">--</span>
                            </div>
                            <div class="op-item" title="Nascer do Sol">
                                <i class="fa-solid fa-sun" style="color:#fbbf24"></i>
                                <span class="op-val" id="sunrise-txt">--:--</span>
                            </div>
                            <div class="op-item" title="Pôr do Sol">
                                <i class="fa-solid fa-moon" style="color:#a78bfa"></i>
                                <span class="op-val" id="sunset-txt">--:--</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="weather-forecast-col">
                    <div>
                        <div class="forecast-section-title">Previsão Horária</div>
                        <div class="scroll-container" id="hourly-row"></div>
                    </div>
                    <div>
                        <div class="forecast-section-title">Próximos Dias</div>
                        <div class="scroll-container" id="daily-row"></div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // --- 1. FULLSCREEN TOGGLE ---
        function toggleFullScreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
                document.getElementById('fs-icon').classList.remove('fa-expand');
                document.getElementById('fs-icon').classList.add('fa-compress');
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                    document.getElementById('fs-icon').classList.add('fa-expand');
                    document.getElementById('fs-icon').classList.remove('fa-compress');
                }
            }
        }

        // --- 2. PIXEL SHIFT (Burn-in Protection) ---
        // Move o conteúdo ligeiramente a cada 5 minutos
        function performPixelShift() {
            const body = document.getElementById('body-el');
            // Move aleatoriamente entre -3px e 3px
            const x = Math.floor(Math.random() * 7) - 3; 
            const y = Math.floor(Math.random() * 7) - 3;
            
            // Aplica transform ao body (já tem transition no CSS)
            body.style.transform = `translate(${x}px, ${y}px)`;
            console.log(`Pixel Shift: ${x}px, ${y}px`);
        }
        setInterval(performPixelShift, 300000); // 5 min

        // --- 3. WATCHDOG & LOGICA DE ALERTA ---
        let alertTimeout = null;
        let isAlertActive = false;
        const watchdog = document.getElementById('watchdog');

        function setSystemStatus(isOnline) {
            if(isOnline) {
                watchdog.classList.remove('offline');
                watchdog.title = "Sistema Online - Dados Atualizados";
            } else {
                watchdog.classList.add('offline');
                watchdog.title = "ERRO: Sem ligação ou falha na API";
            }
        }

        // Monitorizar queda de internet do browser
        window.addEventListener('offline', () => setSystemStatus(false));
        window.addEventListener('online', () => setSystemStatus(true));

        function triggerShiftAlert() {
            if (isAlertActive) return; 
            isAlertActive = true;
            document.body.classList.add('shift-alert-active');
            
            if(alertTimeout) clearTimeout(alertTimeout);
            alertTimeout = setTimeout(() => {
                document.body.classList.remove('shift-alert-active');
                isAlertActive = false;
            }, 60000);
        }

        // --- RELÓGIO ---
        function updateClock() {
            const now = new Date();
            const h = String(now.getHours()).padStart(2, '0');
            const m = String(now.getMinutes()).padStart(2, '0');
            const s = String(now.getSeconds()).padStart(2, '0');

            document.getElementById('h').textContent = h;
            document.getElementById('m').textContent = m;
            document.getElementById('s').textContent = s;

            if (m === '00' && s === '00') {
                if (h === '08' || h === '20') {
                    triggerShiftAlert();
                }
            }

            const options = { weekday: 'long', day: 'numeric', month: 'long' };
            let dateStr = now.toLocaleDateString('pt-PT', options);
            dateStr = dateStr.charAt(0).toUpperCase() + dateStr.slice(1);
            document.getElementById('date-full').textContent = dateStr;
        }
        setInterval(updateClock, 1000);
        updateClock();

        // --- METEOROLOGIA (API Atualizada) ---
        // Adicionados: wind_speed_10m, wind_direction_10m, sunrise, sunset
        const API_URL = "https://api.open-meteo.com/v1/forecast?latitude=39.74&longitude=-8.81&current=temperature_2m,weather_code,is_day,wind_speed_10m,wind_direction_10m&hourly=temperature_2m,weather_code,is_day&daily=weather_code,temperature_2m_max,temperature_2m_min,sunrise,sunset&timezone=auto&forecast_days=7";

        const weatherMap = {
            0: { icon: 'fa-sun', text: 'Limpo' }, 1: { icon: 'fa-cloud-sun', text: 'Pouco nublado' },
            2: { icon: 'fa-cloud-sun', text: 'Parcial nublado' }, 3: { icon: 'fa-cloud', text: 'Nublado' },
            45: { icon: 'fa-smog', text: 'Nevoeiro' }, 48: { icon: 'fa-smog', text: 'Nevoeiro' },
            51: { icon: 'fa-cloud-rain', text: 'Chuvisco' }, 53: { icon: 'fa-cloud-rain', text: 'Chuvisco' },
            61: { icon: 'fa-umbrella', text: 'Chuva' }, 63: { icon: 'fa-umbrella', text: 'Chuva' },
            80: { icon: 'fa-cloud-showers-heavy', text: 'Aguaceiros' }, 95: { icon: 'fa-bolt', text: 'Trovoada' }
        };

        // Helper: Graus para Cardeais
        function degToCompass(num) {
            const val = Math.floor((num / 22.5) + 0.5);
            const arr = ["N", "NNE", "NE", "ENE", "E", "ESE", "SE", "SSE", "S", "SSW", "SW", "WSW", "W", "WNW", "NW", "NNW"];
            return arr[(val % 16)];
        }

        // Helper: Extrair HH:MM da data ISO
        function formatTimeISO(isoString) {
            if(!isoString) return "--:--";
            const d = new Date(isoString);
            return String(d.getHours()).padStart(2, '0') + ":" + String(d.getMinutes()).padStart(2, '0');
        }

        function getWeatherInfo(code, isDay = 1) {
            let info = weatherMap[code] || { icon: 'fa-cloud', text: 'Nublado' };
            // Copia o objeto para não alterar o original
            let iconClass = info.icon;
            if (isDay === 0) {
                if (iconClass === 'fa-sun') iconClass = 'fa-moon';
                if (iconClass === 'fa-cloud-sun') iconClass = 'fa-cloud-moon';
            }
            return { icon: iconClass, text: info.text };
        }

        async function updateWeather() {
            try {
                const res = await fetch(API_URL);
                if(!res.ok) throw new Error("API Error");
                
                const data = await res.json();
                const curr = data.current;
                const info = getWeatherInfo(curr.weather_code, curr.is_day);

                // Básicos
                document.getElementById('temp-val').textContent = Math.round(curr.temperature_2m);
                document.getElementById('cond-text').textContent = info.text;
                document.getElementById('main-icon').innerHTML = `<i class="fa-solid ${info.icon}"></i>`;

                // NOVOS DADOS OPERACIONAIS
                document.getElementById('wind-txt').textContent = Math.round(curr.wind_speed_10m) + " km/h";
                document.getElementById('wind-dir').textContent = degToCompass(curr.wind_direction_10m);
                
                // Nascer/Por do Sol (índice 0 é hoje)
                document.getElementById('sunrise-txt').textContent = formatTimeISO(data.daily.sunrise[0]);
                document.getElementById('sunset-txt').textContent = formatTimeISO(data.daily.sunset[0]);

                // Horária
                const hCont = document.getElementById('hourly-row');
                hCont.innerHTML = '';
                const currentHour = new Date().getHours();
                for (let i = 1; i <= 5; i++) {
                    const idx = currentHour + i;
                    if(!data.hourly.time[idx]) continue;
                    const dateObj = new Date(data.hourly.time[idx]);
                    const hourLabel = String(dateObj.getHours()).padStart(2, '0') + ":00";
                    const temp = Math.round(data.hourly.temperature_2m[idx]);
                    const wInfo = getWeatherInfo(data.hourly.weather_code[idx], data.hourly.is_day[idx]);

                    hCont.innerHTML += `
                        <div class="forecast-unit">
                            <span class="f-time">${hourLabel}</span>
                            <i class="fa-solid ${wInfo.icon} f-icon"></i>
                            <span class="f-temp">${temp}°</span>
                        </div>`;
                }

                // Diária
                const dCont = document.getElementById('daily-row');
                dCont.innerHTML = '';
                for (let i = 1; i <= 5; i++) {
                    const d = new Date(data.daily.time[i]);
                    let dName = d.toLocaleDateString('pt-PT', { weekday: 'short' }).replace('.', '');
                    dName = dName.charAt(0).toUpperCase() + dName.slice(1);
                    const max = Math.round(data.daily.temperature_2m_max[i]);
                    const min = Math.round(data.daily.temperature_2m_min[i]);
                    const wInfo = getWeatherInfo(data.daily.weather_code[i], 1);

                    dCont.innerHTML += `
                        <div class="forecast-unit">
                            <span class="f-time" style="font-weight: 500;">${dName}</span>
                            <i class="fa-solid ${wInfo.icon} f-icon"></i>
                            <div><span class="f-temp">${max}°</span> <span class="f-temp min-temp">/${min}°</span></div>
                        </div>`;
                }
                
                // Sucesso: Watchdog Verde
                setSystemStatus(true);

            } catch(e) { 
                console.error("Erro meteo", e); 
                // Falha: Watchdog Vermelho
                setSystemStatus(false);
            }
        }
        
        updateWeather();
        setInterval(updateWeather, 300000); // 5 minutos
    </script>
</body>
</html>